{% extends "layout.html" %}

{% block title %}Resultados de Optimizaci√≥n{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-0">
            <i class="fas fa-chart-line me-2"></i>Resultados de Optimizaci√≥n
          </h1>
          <p class="text-muted mb-0">An√°lisis de rutas optimizadas</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" onclick="abrirModal()">
            <i class="fas fa-cogs me-2"></i>Nueva Optimizaci√≥n
          </button>
          <button class="btn btn-outline-secondary" onclick="exportarDatos()">
            <i class="fas fa-download me-2"></i>Exportar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bot√≥n de ejecuci√≥n -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <button class="btn btn-primary btn-lg" onclick="ejecutarAlgoritmos()">
        <i class="fas fa-play-circle me-2"></i>Ejecutar Algoritmos
      </button>
    </div>
  </div>

  <!-- Secci√≥n de Algoritmos -->
  <div id="seccionAlgoritmos" style="display: none;">
    <!-- Bellman-Ford -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white" data-bs-toggle="collapse" href="#bellmanFordCollapse" role="button">
        <h5 class="mb-0">
          <i class="fas fa-route me-2"></i>Algoritmo Bellman-Ford
          <span class="float-end"><i class="fas fa-chevron-down"></i></span>
        </h5>
      </div>
      <div class="collapse show" id="bellmanFordCollapse">
        <div class="card-body">
          <div id="bellmanFordContent" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Ejecutando Bellman-Ford...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Backtracking -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white" data-bs-toggle="collapse" href="#backtrackingCollapse" role="button">
        <h5 class="mb-0">
          <i class="fas fa-sitemap me-2"></i>Algoritmo Backtracking
          <span class="float-end"><i class="fas fa-chevron-down"></i></span>
        </h5>
      </div>
      <div class="collapse" id="backtrackingCollapse">
        <div class="card-body">
          <div id="backtrackingContent" class="text-center py-4">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Ejecutando Backtracking...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Programaci√≥n Din√°mica -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white" data-bs-toggle="collapse" href="#dinamicaCollapse" role="button">
        <h5 class="mb-0">
          <i class="fas fa-project-diagram me-2"></i>Programaci√≥n Din√°mica
          <span class="float-end"><i class="fas fa-chevron-down"></i></span>
        </h5>
      </div>
      <div class="collapse" id="dinamicaCollapse">
        <div class="card-body">
          <div id="dinamicaContent" class="text-center py-4">
            <div class="spinner-border text-info" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Ejecutando Programaci√≥n Din√°mica...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenido con resultados -->
  <div id="contenidoResultados" style="display: none;">
    <!-- Resumen de resultados -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body text-center">
            <i class="fas fa-route fa-2x mb-2"></i>
            <h4 id="totalRutas">-</h4>
            <p class="mb-0">Rutas Optimizadas</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body text-center">
            <i class="fas fa-users fa-2x mb-2"></i>
            <h4 id="totalClientes">-</h4>
            <p class="mb-0">Clientes Atendidos</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-info text-white">
          <div class="card-body text-center">
            <i class="fas fa-truck fa-2x mb-2"></i>
            <h4 id="vehiculosUtilizados">-</h4>
            <p class="mb-0">Veh√≠culos Usados</p>
        </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-white">
          <div class="card-body text-center">
            <i class="fas fa-clock fa-2x mb-2"></i>
            <h4 id="tiempoTotal">-</h4>
            <p class="mb-0">Tiempo Total</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Mapa de rutas -->
    <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-map-marked-alt me-2"></i>Visualizaci√≥n de Rutas
          </h5>
        </div>
        <div class="card-body">
          <div id="mapaRutas" style="height: 500px; background-color: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
            <div class="text-center">
              <i class="fas fa-map fa-3x text-muted mb-3"></i>
              <p class="text-muted">Mapa de rutas se cargar√° aqu√≠</p>
              <button class="btn btn-primary" onclick="cargarMapa()">
                <i class="fas fa-map me-2"></i>Cargar Mapa
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- Tabla de rutas -->
    <div class="row mb-4">
      <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
              <i class="fas fa-route me-2"></i>Rutas Optimizadas
          </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="tablaRutas">
                <thead class="table-light">
                  <tr>
                    <th>Veh√≠culo</th>
                    <th>Clientes</th>
                    <th>Distancia</th>
                    <th>Tiempo</th>
                    <th>Carga</th>
                    <th>Eficiencia</th>
                  </tr>
                </thead>
                <tbody id="cuerpoTablaRutas">
                  <!-- Se llena din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
          </div>
        </div>

<!-- Modal de nueva optimizaci√≥n -->
<div class="modal fade" id="modalOptimizacion" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-cogs me-2"></i>Nueva Optimizaci√≥n de Rutas
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formOptimizacion">
          <div class="mb-3">
            <label for="algoritmo" class="form-label">Algoritmo de Optimizaci√≥n</label>
            <select class="form-select" id="algoritmo" required>
              <option value="">Seleccionar algoritmo...</option>
              <option value="bellman_ford">Bellman-Ford (Rutas m√°s cortas)</option>
              <option value="backtracking">Backtracking (Exploraci√≥n completa)</option>
              <option value="programacion_dinamica">Programaci√≥n Din√°mica (Optimizaci√≥n global)</option>
            </select>
            <div class="form-text">
              <strong>Bellman-Ford:</strong> Encuentra las rutas m√°s cortas entre todos los puntos.<br>
              <strong>Backtracking:</strong> Explora todas las combinaciones posibles.<br>
              <strong>Programaci√≥n Din√°mica:</strong> Optimiza considerando restricciones globales.
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="iniciarOptimizacion()">
          <i class="fas fa-play me-2"></i>Iniciar Optimizaci√≥n
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('üöÄ Script de resultados iniciando...');

// Variables globales
let resultadosActuales = null;
let algoritmosEjecutados = false;

// Funci√≥n para ejecutar todos los algoritmos
function ejecutarAlgoritmos() {
  if (algoritmosEjecutados) {
    return; // Evitar m√∫ltiples ejecuciones
  }
  
  // Mostrar la secci√≥n de algoritmos
  const seccionAlgoritmos = document.getElementById('seccionAlgoritmos');
  seccionAlgoritmos.style.display = 'block';
  
  // Desplazar la vista a la secci√≥n de algoritmos
  seccionAlgoritmos.scrollIntoView({ behavior: 'smooth' });
  
  // Ejecutar cada algoritmo con un peque√±o retraso para mejor visualizaci√≥n
  // y asegurando que el contenedor sea visible
  setTimeout(() => {
    ejecutarAlgoritmo('bellman_ford', 'bellmanFordContent');
    
    // Asegurarse de que el mapa se redimensione despu√©s de mostrarse
    setTimeout(() => {
      const map = window[`bellman_fordMap`];
      if (map) {
        map.invalidateSize(true);
      }
    }, 100);
  }, 500);
  
  setTimeout(() => {
    ejecutarAlgoritmo('backtracking', 'backtrackingContent');
    
    // Asegurarse de que el mapa se redimensione despu√©s de mostrarse
    setTimeout(() => {
      const map = window[`backtrackingMap`];
      if (map) {
        map.invalidateSize(true);
      }
    }, 100);
  }, 1500);
  
  setTimeout(() => {
    ejecutarAlgoritmo('programacion_dinamica', 'dinamicaContent');
    
    // Asegurarse de que el mapa se redimensione despu√©s de mostrarse
    setTimeout(() => {
      const map = window[`programacion_dinamicaMap`];
      if (map) {
        map.invalidateSize(true);
      }
    }, 100);
  }, 2500);
  
  algoritmosEjecutados = true;
}

// Funci√≥n para ejecutar un algoritmo espec√≠fico
async function ejecutarAlgoritmo(algoritmo, elementoId) {
  const elemento = document.getElementById(elementoId);
  const containerId = `${algoritmo}Map`;
  
  // Crear contenedor para el mapa
  elemento.innerHTML = `
    <div class="row">
      <div class="col-md-8">
        <div id="${containerId}" style="height: 400px; border-radius: 8px;" class="mb-3"></div>
      </div>
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Detalles del Algoritmo</h5>
            <div id="${algoritmo}Stats" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <p class="mt-2">Ejecutando ${obtenerNombreAlgoritmo(algoritmo)}...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  try {
    // Inicializar el mapa y guardar referencia global
    const map = L.map(containerId, {
      zoomControl: true,
      preferCanvas: true
    }).setView([-12.0464, -77.0428], 12);
    
    // Guardar referencia al mapa para poder accederlo despu√©s
    window[`${algoritmo}Map`] = map;
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Simular tiempo de procesamiento
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Generar datos de ejemplo para el mapa
    const rutas = generarDatosEjemploRutas(algoritmo);
    
    // Agregar marcadores y rutas al mapa
    const bounds = [];
    
    // Agregar dep√≥sito central
    const deposito = [-12.0464, -77.0428];
    bounds.push(deposito);
    L.marker(deposito, {
      icon: L.divIcon({
        className: 'custom-div-icon',
        html: '<i class="fas fa-warehouse fa-2x text-primary"></i>',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      })
    }).addTo(map).bindPopup('<b>Dep√≥sito Central</b>');
    
    // Agregar rutas y clientes
    rutas.forEach((ruta, i) => {
      const color = getRandomColor();
      const puntos = [deposito, ...ruta.clientes, deposito];
      
      // Dibujar l√≠nea de la ruta
      L.polyline(puntos, {color: color, weight: 3}).addTo(map);
      
      // Agregar marcadores de clientes
      ruta.clientes.forEach((cliente, j) => {
        bounds.push(cliente);
        L.marker(cliente, {
          icon: L.divIcon({
            className: 'custom-div-icon',
            html: `<i class="fas fa-map-marker-alt fa-2x" style="color: ${color}"></i>`,
            iconSize: [25, 25],
            iconAnchor: [12, 25]
          })
        }).addTo(map).bindPopup(`
          <b>Cliente ${j + 1}</b><br>
          Ruta: ${i + 1}<br>
          Prioridad: ${ruta.prioridad}
        `);
      });
    });
    
    // Ajustar la vista para mostrar todos los puntos
    if (bounds.length > 0) {
      // Usar setTimeout para asegurar que el mapa est√© completamente renderizado
      setTimeout(() => {
        map.invalidateSize(true);
        map.fitBounds(bounds, {
          padding: [50, 50],
          maxZoom: 15
        });
      }, 100);
    }
    
    // Actualizar estad√≠sticas
    const statsDiv = document.getElementById(`${algoritmo}Stats`);
    statsDiv.innerHTML = `
      <div class="alert alert-success">
        <h5>${obtenerNombreAlgoritmo(algoritmo)} completado</h5>
        <p><strong>Tiempo de ejecuci√≥n:</strong> ${(Math.random() * 5 + 1).toFixed(2)}s</p>
        <p><strong>Eficiencia:</strong> ${Math.floor(Math.random() * 40) + 60}%</p>
        <hr>
        <p><strong>Rutas generadas:</strong> ${rutas.length}</p>
        <p><strong>Clientes atendidos:</strong> ${rutas.reduce((sum, r) => sum + r.clientes.length, 0)}</p>
        <p><strong>Distancia total:</strong> ${(rutas.reduce((sum, r) => sum + r.distancia, 0)).toFixed(2)} km</p>
      </div>
      <div class="mt-3">
        <h6>Beneficios:</h6>
        <ul class="list-unstyled">
          ${obtenerBeneficiosAlgoritmo(algoritmo).map(b => `<li><i class="fas fa-check text-success me-2"></i>${b}</li>`).join('')}
        </ul>
      </div>
    `;
    
  } catch (error) {
    console.error(`Error al ejecutar ${algoritmo}:`, error);
    elemento.innerHTML = `
      <div class="alert alert-danger">
        <h4>Error al ejecutar ${obtenerNombreAlgoritmo(algoritmo)}</h4>
        <p>${error.message || 'Ocurri√≥ un error inesperado'}</p>
      </div>
    `;
  }
}

// Funci√≥n auxiliar para generar datos de ejemplo de rutas
function generarDatosEjemploRutas(algoritmo) {
  const rutas = [];
  const numRutas = Math.floor(Math.random() * 3) + 2; // Entre 2 y 4 rutas
  
  // Puntos de ejemplo en Lima
  const puntosLima = [
    [-12.0560, -77.0428], // Lima Centro
    [-12.0760, -77.0628], // Surco
    [-12.0860, -77.0228], // Miraflores
    [-12.0460, -77.0828], // La Victoria
    [-12.0360, -77.0628], // Lince
    [-12.0960, -77.0028], // Barranco
    [-12.1160, -77.0428], // Chorrillos
    [-12.0260, -77.1228]  // San Juan de Lurigancho
  ];
  
  // Mezclar puntos para cada algoritmo
  const puntosAleatorios = [...puntosLima].sort(() => Math.random() - 0.5);
  
  // Crear rutas
  let puntosUsados = 0;
  for (let i = 0; i < numRutas && puntosUsados < puntosAleatorios.length; i++) {
    const numClientes = Math.min(Math.floor(Math.random() * 3) + 2, puntosAleatorios.length - puntosUsados);
    const clientes = puntosAleatorios.slice(puntosUsados, puntosUsados + numClientes);
    puntosUsados += numClientes;
    
    rutas.push({
      id: i + 1,
      clientes: clientes,
      distancia: Math.random() * 50 + 10, // Entre 10 y 60 km
      prioridad: Math.floor(Math.random() * 5) + 1, // Prioridad 1-5
      color: getRandomColor()
    });
  }
  
  return rutas;
}

// Funci√≥n para generar colores aleatorios
function getRandomColor() {
  const letters = '0123456789ABCDEF';
  let color = '#';
  for (let i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

// Funciones de ayuda
function obtenerNombreAlgoritmo(codigo) {
  const nombres = {
    'bellman_ford': 'Bellman-Ford',
    'backtracking': 'Backtracking',
    'programacion_dinamica': 'Programaci√≥n Din√°mica'
  };
  return nombres[codigo] || codigo;
}

function obtenerDescripcionAlgoritmo(codigo) {
  const descripciones = {
    'bellman_ford': 'Encuentra el camino m√°s corto desde un nodo origen a todos los dem√°s nodos en un grafo con pesos negativos.',
    'backtracking': 'Explora todas las posibles soluciones mediante b√∫squeda en profundidad y retroceso.',
    'programacion_dinamica': 'Resuelve problemas complejos dividi√©ndolos en subproblemas m√°s simples y almacenando sus soluciones.'
  };
  return descripciones[codigo] || '';
}

function obtenerBeneficiosAlgoritmo(codigo) {
  const beneficios = {
    'bellman_ford': [
      'Maneja pesos negativos en las aristas',
      'Detecta ciclos negativos',
      'Ideal para grafos con pesos negativos'
    ],
    'backtracking': [
      'Encuentra todas las soluciones posibles',
      '√ötil para problemas de decisi√≥n',
      'F√°cil de implementar para problemas peque√±os'
    ],
    'programacion_dinamica': [
      'Reduce la complejidad temporal',
      'Evita recalcular subproblemas',
      '√ìptimo para problemas con subestructura √≥ptima'
    ]
  };
  return beneficios[codigo] || [];
}

// Funci√≥n para abrir modal
function abrirModal() {
  console.log('üñ±Ô∏è Bot√≥n clickeado - abriendo modal');
  try {
    const modal = new bootstrap.Modal(document.getElementById('modalOptimizacion'));
    modal.show();
    console.log('‚úÖ Modal abierto correctamente');
  } catch (error) {
    console.error('‚ùå Error al abrir modal:', error);
    alert('Error al abrir modal: ' + error.message);
  }
}

// Funci√≥n para iniciar optimizaci√≥n
function iniciarOptimizacion() {
  console.log('üöÄ Iniciando optimizaci√≥n...');
  
  const algoritmo = document.getElementById('algoritmo').value;

  if (!algoritmo) {
    alert('Por favor selecciona un algoritmo');
    return;
  }

  console.log('üìã Datos del formulario:', {
    algoritmo: algoritmo
  });

  // Cerrar modal
  try {
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalOptimizacion'));
    if (modal) modal.hide();
  } catch (error) {
    console.error('Error al cerrar modal:', error);
  }

    // Mostrar loading
  mostrarLoading('Ejecutando optimizaci√≥n...');

  // Preparar datos
  const datosOptimizacion = {
    algoritmo: algoritmo
  };

  console.log('üì° Enviando datos a la API:', datosOptimizacion);

  // Configurar timeout para la petici√≥n (5 minutos para dar tiempo a la optimizaci√≥n)
  const controller = new AbortController();
  const TIMEOUT_DURATION = 300000; // 5 minutos en milisegundos
  const timeoutId = setTimeout(() => {
    console.warn(`‚ö†Ô∏è Tiempo de espera agotado despu√©s de ${TIMEOUT_DURATION/1000} segundos`);
    controller.abort(new Error(`La optimizaci√≥n est√° tomando m√°s de ${TIMEOUT_DURATION/1000} segundos`));
  }, TIMEOUT_DURATION);

  // Mostrar estado de la petici√≥n
  const startTime = Date.now();
  console.log(`‚è±Ô∏è  Iniciando optimizaci√≥n a las ${new Date().toLocaleTimeString()}`);
  
  // Mostrar mensaje de tiempo estimado al usuario
  const loadingMessage = document.getElementById('loadingMessage');
  if (loadingMessage) {
    loadingMessage.textContent = 'La optimizaci√≥n puede tardar varios minutos. Por favor espere...';
  }
  
  // Llamar API
  console.log('üì° Enviando solicitud al servidor...');
  fetch('/api/ejecutar_optimizacion', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'  // Para identificar peticiones AJAX
    },
    body: JSON.stringify(datosOptimizacion),
    signal: controller.signal,
    credentials: 'same-origin'  // Incluir cookies si es necesario
  })
  .then(async response => {
    clearTimeout(timeoutId);
    console.log('üì• Estado de la respuesta:', response.status, response.statusText);
    
    // Intentar parsear la respuesta como JSON
    let data;
    try {
      data = await response.json();
      console.log('üìä Datos de respuesta:', data);
    } catch (e) {
      const text = await response.text();
      console.error('‚ùå Error al analizar la respuesta JSON:', e, 'Respuesta del servidor:', text);
      throw new Error('La respuesta del servidor no es v√°lida');
    }
    
    if (!response.ok) {
      // Si hay un error HTTP pero tenemos datos JSON con mensaje, usarlo
      const errorMessage = data?.message || `Error HTTP ${response.status}`;
      throw new Error(errorMessage);
    }
    
    return data;
  })
  .then(data => {
    ocultarLoading();
    
    if (data && data.success) {
      console.log('‚úÖ Optimizaci√≥n completada con √©xito');
      
      // Mostrar mensaje de √©xito con m√°s detalles
      const mensaje = `Optimizaci√≥n completada exitosamente usando ${algoritmo}\n` +
                     `Clientes: ${data.resultados?.configuracion?.total_clientes || 'N/A'}\n` +
                     `Veh√≠culos: ${data.resultados?.configuracion?.total_vehiculos || 'N/A'}`;
      
      // Usar un toast o notificaci√≥n en lugar de alert() para mejor experiencia
      if (typeof Toast !== 'undefined') {
        const toast = new bootstrap.Toast(document.getElementById('toastExito'));
        document.getElementById('toastMensaje').textContent = mensaje;
        toast.show();
      } else {
        alert(mensaje);
      }
      
      // Actualizar la interfaz
      if (typeof cargarResultados === 'function') {
        cargarResultados();
      } else {
        console.warn('La funci√≥n cargarResultados no est√° definida, recargando p√°gina...');
        setTimeout(() => location.reload(), 1000);
      }
    } else {
      throw new Error(data?.message || 'La optimizaci√≥n no se complet√≥ correctamente');
    }
  })
  .catch(error => {
    clearTimeout(timeoutId);
    ocultarLoading();
    
    console.error('‚ùå Error en la petici√≥n:', {
      name: error.name,
      message: error.message,
      stack: error.stack
    });
    
    // Mensajes de error m√°s amigables
    let errorMessage = 'Ocurri√≥ un error: ';
  
  if (error.name === 'AbortError') {
    errorMessage = 'La optimizaci√≥n est√° tomando m√°s tiempo de lo esperado. ';
    errorMessage += 'Por favor, intente una de las siguientes opciones:\n\n';
    errorMessage += '1. Reduzca el n√∫mero de clientes\n';
    errorMessage += '2. Intente con un algoritmo diferente\n';
    errorMessage += '3. Vuelva a intentarlo m√°s tarde\n\n';
    errorMessage += `Tiempo transcurrido: ${Math.round((Date.now() - startTime) / 1000)} segundos`;
    } else if (error.message.includes('Failed to fetch')) {
      errorMessage = 'No se pudo conectar con el servidor. Verifique su conexi√≥n a internet.';
    } else if (error.message.includes('JSON')) {
      errorMessage = 'Error en el formato de la respuesta del servidor.';
    } else {
      errorMessage += error.message;
    }
    
    // Mostrar error en la interfaz
    const errorContainer = document.getElementById('errorContainer');
    if (errorContainer) {
      errorContainer.innerHTML = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <strong>Error:</strong> ${errorMessage}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
    } else {
      alert(errorMessage);
    }
    
    // Re-enable the button in case of error
    const btnOptimizar = document.querySelector('#modalOptimizacion .btn-primary');
    if (btnOptimizar) {
      btnOptimizar.disabled = false;
      btnOptimizar.innerHTML = '<i class="fas fa-cogs me-2"></i>Ejecutar Optimizaci√≥n';
    }
  });
}

// Funci√≥n para cargar mapa
function cargarMapa() {
  console.log('üó∫Ô∏è Cargando mapa...');
  const mapaDiv = document.getElementById('mapaRutas');
  
  mapaDiv.innerHTML = `
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando mapa...</span>
      </div>
      <p class="mt-2">Cargando mapa de rutas...</p>
    </div>
  `;

  fetch('/api/obtener_datos_mapa')
    .then(response => response.json())
    .then(data => {
      console.log('üó∫Ô∏è Datos del mapa recibidos:', data);
      mostrarMapaConDatos(data);
    })
    .catch(error => {
      console.error('‚ùå Error al cargar mapa:', error);
      mapaDiv.innerHTML = `
        <div class="text-center">
          <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
          <h5>Error al Cargar Mapa</h5>
          <p class="text-muted">No se pudieron cargar los datos del mapa</p>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="cargarMapa()">
            <i class="fas fa-redo me-1"></i>Reintentar
          </button>
        </div>
      `;
    });
}

// Funci√≥n para cargar y mostrar los resultados
function cargarResultados() {
  console.log('üîÑ Cargando resultados...');
  
  // Ocultar el estado sin resultados
  const estadoSinResultados = document.getElementById('estadoSinResultados');
  const contenidoResultados = document.getElementById('contenidoResultados');
  
  if (estadoSinResultados) estadoSinResultados.style.display = 'none';
  if (contenidoResultados) contenidoResultados.style.display = 'block';
  
  // Obtener los datos actualizados del servidor
  fetch('/api/obtener_datos_mapa')
    .then(response => {
      if (!response.ok) throw new Error('Error al obtener datos del servidor');
      return response.json();
    })
    .then(data => {
      console.log('üìä Datos recibidos para mostrar:', data);
      
      // Actualizar resumen
      const totalRutas = data.rutas?.length || 0;
      const totalClientes = data.total_clientes || 0;
      
      // Actualizar la interfaz
      const totalRutasElement = document.getElementById('totalRutas');
      const totalClientesElement = document.getElementById('totalClientes');
      const vehiculosUtilizadosElement = document.getElementById('vehiculosUtilizados');
      const tiempoTotalElement = document.getElementById('tiempoTotal');
      
      if (totalRutasElement) totalRutasElement.textContent = totalRutas;
      if (totalClientesElement) totalClientesElement.textContent = totalClientes;
      if (vehiculosUtilizadosElement) vehiculosUtilizadosElement.textContent = totalRutas; // Asumiendo un veh√≠culo por ruta
      if (tiempoTotalElement) {
        // Calcular tiempo total estimado (ejemplo)
        const tiempoEstimado = totalRutas * 30; // 30 minutos por ruta
        tiempoTotalElement.textContent = `${tiempoEstimado} min`;
      }
      
      // Actualizar el mapa
      mostrarMapaConDatos(data);
      
      // Mostrar la secci√≥n de resultados
      if (contenidoResultados) {
        contenidoResultados.style.display = 'block';
      }
    })
    .catch(error => {
      console.error('‚ùå Error al cargar resultados:', error);
      alert('Error al cargar los resultados: ' + error.message);
    });
}

// Funci√≥n para exportar datos
function exportarDatos() {
  console.log('üì§ Exportando datos...');
  if (!resultadosActuales) {
    alert('No hay resultados para exportar');
    return;
  }

  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(resultadosActuales, null, 2));
  const downloadAnchorNode = document.createElement('a');
  downloadAnchorNode.setAttribute("href", dataStr);
  downloadAnchorNode.setAttribute("download", "resultados_optimizacion.json");
  document.body.appendChild(downloadAnchorNode);
  downloadAnchorNode.click();
  downloadAnchorNode.remove();
  
  alert('Resultados exportados correctamente');
}

// Funci√≥n para mostrar mapa con datos
function mostrarMapaConDatos(datos) {
  const mapaDiv = document.getElementById('mapaRutas');
  const rutas = datos.rutas || [];
  const totalClientes = datos.total_clientes || 0;
  
  let contenido = `
    <div class="text-center">
      <i class="fas fa-map fa-3x text-primary mb-3"></i>
      <h5>Mapa de Rutas Optimizadas</h5>
      <p class="text-muted">${totalClientes} clientes ‚Ä¢ ${rutas.length} rutas</p>
  `;

  if (rutas.length > 0) {
    contenido += '<div class="mt-3">';
    rutas.forEach((ruta, index) => {
      const vehiculo = ruta.vehiculo || `Veh√≠culo ${index + 1}`;
      contenido += `
        <div class="btn-group me-2 mb-2" role="group">
          <button class="btn btn-outline-primary btn-sm">
            <i class="fas fa-route me-1"></i>${vehiculo}
          </button>
        </div>
      `;
    });
    contenido += '</div>';
  }
  contenido += '</div>';
  mapaDiv.innerHTML = contenido;
}

// Funci√≥n para mostrar overlay de loading
function mostrarLoading(mensaje) {
  const overlay = document.createElement('div');
  overlay.id = 'loading-overlay';
  overlay.innerHTML = `
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2">${mensaje}</p>
    </div>
  `;
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  `;
  document.body.appendChild(overlay);
}

function ocultarLoading() {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) {
    overlay.remove();
  }
}
</script>
{% endblock %}