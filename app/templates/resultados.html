{% extends "layout.html" %}

{% block title %}Resultados de Optimización{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-chart-line me-2"></i>Resultados de Optimización
                </h1>

            </div>
        </div>
    </div>

    <!-- Resumen de resultados -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Distancia Total</h6>
                            <h3 class="mb-0" id="distanciaTotal">0 km</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-route fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Tiempo Estimado</h6>
                            <h3 class="mb-0" id="tiempoEstimado">0 min</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Vehículos Utilizados</h6>
                            <h3 class="mb-0" id="vehiculosUtilizados">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-truck fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Eficiencia</h6>
                            <h3 class="mb-0" id="eficiencia">0%</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-percentage fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa de rutas optimizadas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map-marked-alt me-2"></i>Mapa de Rutas Optimizadas
                    </h5>
                </div>
                <div class="card-body">
                    <div id="mapaResultados" style="height: 600px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detalles de rutas y gráficos -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Detalles de Rutas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tablaRutas">
                            <thead class="table-dark">
                                <tr>
                                    <th>Vehículo</th>
                                    <th>Ruta</th>
                                    <th>Distancia</th>
                                    <th>Tiempo</th>
                                    <th>Carga</th>
                                    <th>Eficiencia</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyRutas">
                                <!-- Las rutas se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Distribución de Carga
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="graficoCarga" width="300" height="200"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Métricas de Rendimiento
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="graficoRendimiento" width="300" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Análisis detallado -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-analytics me-2"></i>Análisis de Eficiencia
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center mb-3">
                                <h4 id="utilizacionCapacidad">0%</h4>
                                <p class="text-muted">Utilización de Capacidad</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center mb-3">
                                <h4 id="clientesAtendidos">0</h4>
                                <p class="text-muted">Clientes Atendidos</p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center mb-3">
                                <h4 id="tiempoPromedio">0 min</h4>
                                <p class="text-muted">Tiempo Promedio por Ruta</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center mb-3">
                                <h4 id="distanciaPromedio">0 km</h4>
                                <p class="text-muted">Distancia Promedio por Ruta</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Alertas y Recomendaciones
                    </h5>
                </div>
                <div class="card-body">
                    <div id="alertasRecomendaciones">
                        <!-- Las alertas se cargarán dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let mapaResultados;
let graficoCarga;
let graficoRendimiento;

document.addEventListener('DOMContentLoaded', function() {
    inicializarMapa();
    cargarResultados();
    inicializarGraficos();
});

function inicializarMapa() {
    // Inicializar mapa centrado en Lima
    mapaResultados = L.map('mapaResultados').setView([-12.0464, -77.0428], 12);
    
    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(mapaResultados);
    
    // Agregar marcador del depósito central
    const depositoIcon = L.divIcon({
        className: 'custom-div-icon',
        html: '<div style="background-color: #dc3545; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white;"></div>',
        iconSize: [25, 25],
        iconAnchor: [12.5, 12.5]
    });
    
    L.marker([-12.0464, -77.0428], {icon: depositoIcon})
        .addTo(mapaResultados)
        .bindPopup('<b>Depósito Central</b><br>Punto de partida y llegada');
}

function cargarResultados() {
    fetch('/api/obtener_datos_mapa')
        .then(response => response.json())
        .then(data => {
            if (data.resultados) {
                mostrarResultados(data.resultados);
                mostrarRutasEnMapa(data.resultados);
                actualizarGraficos(data.resultados);
                generarAlertas(data.resultados);
            } else {
                mostrarAlerta('No hay resultados de optimización disponibles', 'warning');
            }
        })
        .catch(error => {
            console.error('Error al cargar resultados:', error);
            mostrarAlerta('Error al cargar resultados', 'danger');
        });
}

function mostrarResultados(resultados) {
    document.getElementById('distanciaTotal').textContent = formatearDistancia(resultados.distancia_total || 0);
    document.getElementById('tiempoEstimado').textContent = formatearTiempo(resultados.tiempo_estimado || 0);
    document.getElementById('vehiculosUtilizados').textContent = resultados.vehiculos_utilizados || 0;
    document.getElementById('eficiencia').textContent = (resultados.eficiencia || 0) + '%';
    
    document.getElementById('utilizacionCapacidad').textContent = (resultados.utilizacion_capacidad || 0) + '%';
    document.getElementById('clientesAtendidos').textContent = resultados.clientes_atendidos || 0;
    document.getElementById('tiempoPromedio').textContent = formatearTiempo(resultados.tiempo_promedio || 0);
    document.getElementById('distanciaPromedio').textContent = formatearDistancia(resultados.distancia_promedio || 0);
}

function mostrarRutasEnMapa(resultados) {
    if (resultados.rutas) {
        const colores = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'];
        
        resultados.rutas.forEach((ruta, index) => {
            const color = colores[index % colores.length];
            
            // Crear marcadores para cada cliente en la ruta
            ruta.clientes.forEach((cliente, clienteIndex) => {
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: ${color}; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; font-size: 10px; color: white; text-align: center; line-height: 15px;">${clienteIndex + 1}</div>`,
                    iconSize: [15, 15],
                    iconAnchor: [7.5, 7.5]
                });
                
                L.marker([cliente.latitud, cliente.longitud], {icon: icon})
                    .addTo(mapaResultados)
                    .bindPopup(`
                        <b>${cliente.nombre}</b><br>
                        Ruta: ${ruta.vehiculo}<br>
                        Orden: ${clienteIndex + 1}<br>
                        Pedido: ${formatearPeso(cliente.pedido)}
                    `);
            });
            
            // Crear línea de ruta
            const puntos = [
                [-12.0464, -77.0428], // Depósito
                ...ruta.clientes.map(c => [c.latitud, c.longitud]),
                [-12.0464, -77.0428]  // Regreso al depósito
            ];
            
            L.polyline(puntos, {
                color: color,
                weight: 3,
                opacity: 0.8
            }).addTo(mapaResultados);
        });
    }
}

function mostrarRutasEnTabla(resultados) {
    const tbody = document.getElementById('tbodyRutas');
    tbody.innerHTML = '';
    
    if (resultados.rutas) {
        resultados.rutas.forEach((ruta, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="badge bg-primary">${ruta.vehiculo}</span></td>
                <td>${ruta.clientes.map(c => c.nombre).join(' → ')}</td>
                <td>${formatearDistancia(ruta.distancia)}</td>
                <td>${formatearTiempo(ruta.tiempo)}</td>
                <td>${formatearPeso(ruta.carga_total)}</td>
                <td><span class="badge bg-success">${ruta.eficiencia}%</span></td>
            `;
            tbody.appendChild(row);
        });
    }
}

function inicializarGraficos() {
    // Gráfico de distribución de carga
    const ctxCarga = document.getElementById('graficoCarga').getContext('2d');
    graficoCarga = new Chart(ctxCarga, {
        type: 'doughnut',
        data: {
            labels: ['Utilizada', 'Disponible'],
            datasets: [{
                data: [0, 100],
                backgroundColor: ['#28a745', '#e9ecef']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // Gráfico de rendimiento
    const ctxRendimiento = document.getElementById('graficoRendimiento').getContext('2d');
    graficoRendimiento = new Chart(ctxRendimiento, {
        type: 'bar',
        data: {
            labels: ['Eficiencia', 'Utilización', 'Tiempo'],
            datasets: [{
                label: 'Porcentaje',
                data: [0, 0, 0],
                backgroundColor: ['#007bff', '#28a745', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function actualizarGraficos(resultados) {
    if (resultados.utilizacion_capacidad) {
        graficoCarga.data.datasets[0].data = [
            resultados.utilizacion_capacidad,
            100 - resultados.utilizacion_capacidad
        ];
        graficoCarga.update();
    }
    
    if (resultados.eficiencia) {
        graficoRendimiento.data.datasets[0].data = [
            resultados.eficiencia,
            resultados.utilizacion_capacidad || 0,
            Math.min(100, (resultados.tiempo_estimado || 0) / 8 * 100) // Normalizar tiempo a 8 horas
        ];
        graficoRendimiento.update();
    }
}

function generarAlertas(resultados) {
    const alertasDiv = document.getElementById('alertasRecomendaciones');
    alertasDiv.innerHTML = '';
    
    const alertas = [];
    
    // Verificar eficiencia
    if (resultados.eficiencia < 70) {
        alertas.push({
            tipo: 'warning',
            mensaje: 'La eficiencia es menor al 70%. Considere optimizar las rutas.'
        });
    }
    
    // Verificar utilización de capacidad
    if (resultados.utilizacion_capacidad < 60) {
        alertas.push({
            tipo: 'info',
            mensaje: 'La utilización de capacidad es baja. Considere consolidar rutas.'
        });
    }
    
    // Verificar tiempo de ruta
    if (resultados.tiempo_estimado > 480) { // 8 horas
        alertas.push({
            tipo: 'danger',
            mensaje: 'El tiempo total excede 8 horas. Considere usar más vehículos.'
        });
    }
    
    // Mostrar alertas
    alertas.forEach(alerta => {
        const alertaDiv = document.createElement('div');
        alertaDiv.className = `alert alert-${alerta.tipo} alert-dismissible fade show`;
        alertaDiv.innerHTML = `
            ${alerta.mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertasDiv.appendChild(alertaDiv);
    });
    
    if (alertas.length === 0) {
        alertasDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                Todas las métricas están dentro de los rangos óptimos.
            </div>
        `;
    }
}



function formatearDistancia(distancia) {
    return `${distancia.toFixed(1)} km`;
}

function formatearTiempo(tiempo) {
    const horas = Math.floor(tiempo / 60);
    const minutos = tiempo % 60;
    return `${horas}h ${minutos}min`;
}

function formatearPeso(peso) {
    return `${peso.toLocaleString()} kg`;
}
</script>
{% endblock %} 