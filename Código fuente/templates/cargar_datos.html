{% extends "layout.html" %}

{% block title %}Cargar Datos - Optimización de Rutas{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="fas fa-upload me-2"></i>Cargar Datos de Clientes
                </h4>
            </div>
            <div class="card-body">
                <!-- Formulario de carga -->
                <form id="form-cargar-csv" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="archivo-csv" class="form-label">
                            <i class="fas fa-file-csv me-2"></i>Seleccionar archivo CSV
                        </label>
                        <input type="file" class="form-control" id="archivo-csv" name="archivo" 
                               accept=".csv" required>
                        <div class="form-text">
                            El archivo debe contener las columnas: id, nombre, latitud, longitud, prioridad, ventana_inicio, ventana_fin, pedido
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i>Cargar Datos
                        </button>
                    </div>
                </form>
                
                <hr>
                
                <!-- Información del formato -->
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle me-2"></i>Formato Requerido</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Columna</th>
                                        <th>Tipo</th>
                                        <th>Descripción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>id</td>
                                        <td>Texto</td>
                                        <td>Identificador único</td>
                                    </tr>
                                    <tr>
                                        <td>nombre</td>
                                        <td>Texto</td>
                                        <td>Nombre del cliente</td>
                                    </tr>
                                    <tr>
                                        <td>latitud</td>
                                        <td>Número</td>
                                        <td>Coordenada latitud (-90 a 90)</td>
                                    </tr>
                                    <tr>
                                        <td>longitud</td>
                                        <td>Número</td>
                                        <td>Coordenada longitud (-180 a 180)</td>
                                    </tr>
                                    <tr>
                                        <td>prioridad</td>
                                        <td>Entero</td>
                                        <td>Prioridad (1-5, 1=más alta)</td>
                                    </tr>
                                    <tr>
                                        <td>ventana_inicio</td>
                                        <td>Hora</td>
                                        <td>Hora inicio (HH:MM)</td>
                                    </tr>
                                    <tr>
                                        <td>ventana_fin</td>
                                        <td>Hora</td>
                                        <td>Hora fin (HH:MM)</td>
                                    </tr>
                                    <tr>
                                        <td>pedido</td>
                                        <td>Número</td>
                                        <td>Peso del pedido en kg</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6><i class="fas fa-download me-2"></i>Descargar Ejemplo</h6>
                        <p class="text-muted">
                            Descarga un archivo CSV de ejemplo para ver el formato correcto.
                        </p>
                        <button class="btn btn-outline-primary" onclick="descargarEjemplo()">
                            <i class="fas fa-download me-2"></i>Descargar CSV de Ejemplo
                        </button>
                        
                        <hr>
                        
                        <h6><i class="fas fa-map-marker-alt me-2"></i>Coordenadas de Lima</h6>
                        <p class="text-muted">
                            <strong>Centro de Lima:</strong> -12.0464, -77.0428<br>
                            <strong>Rango recomendado:</strong><br>
                            Latitud: -12.2 a -11.8<br>
                            Longitud: -77.2 a -76.8
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resultados de la carga -->
        <div class="card mt-4" id="resultados-carga" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-check-circle me-2"></i>Resultados de la Carga
                </h5>
            </div>
            <div class="card-body">
                <div id="resumen-carga"></div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Estadísticas de Prioridad</h6>
                        <canvas id="chart-prioridades-carga" width="300" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6>Distribución Geográfica</h6>
                        <div id="mapa-preview" style="height: 200px; border-radius: 10px;"></div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <a href="{{ url_for('index') }}" class="btn btn-success">
                        <i class="fas fa-home me-2"></i>Ir al Dashboard
                    </a>
                    <a href="{{ url_for('ejecutar') }}" class="btn btn-warning">
                        <i class="fas fa-play me-2"></i>Ejecutar Optimización
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let mapaPreview = null;

document.addEventListener('DOMContentLoaded', function() {
    // Configurar formulario
    const form = document.getElementById('form-cargar-csv');
    form.addEventListener('submit', cargarCSV);
    
    // Configurar drag and drop
    const dropZone = document.getElementById('archivo-csv');
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('drop', handleDrop);
});

function cargarCSV(event) {
    event.preventDefault();
    
    const fileInput = document.getElementById('archivo-csv');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Error', 'Por favor seleccione un archivo', 'error');
        return;
    }
    
    if (!file.name.endsWith('.csv')) {
        showToast('Error', 'El archivo debe ser un CSV', 'error');
        return;
    }
    
    showLoading('Procesando archivo CSV...');
    
    const formData = new FormData();
    formData.append('archivo', file);
    
    fetch('/api/cargar_csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            showToast('Éxito', data.message, 'success');
            mostrarResultadosCarga(data);
        } else {
            showToast('Error', data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showToast('Error', 'Error al procesar el archivo', 'error');
    });
}

function mostrarResultadosCarga(data) {
    const resultadosDiv = document.getElementById('resultados-carga');
    const resumenDiv = document.getElementById('resumen-carga');
    
    resumenDiv.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Archivo procesado correctamente</h6>
            <p class="mb-0">Se cargaron ${data.clientes_count} clientes exitosamente.</p>
        </div>
    `;
    
    resultadosDiv.style.display = 'block';
    
    // Cargar datos para visualización
    cargarDatosParaVisualizacion();
}

function cargarDatosParaVisualizacion() {
    fetch('/api/obtener_datos_mapa')
        .then(response => response.json())
        .then(data => {
            // Crear gráfico de prioridades
            crearGraficoPrioridades(data.clientes);
            
            // Crear mapa de preview
            crearMapaPreview(data.clientes);
        })
        .catch(error => {
            console.error('Error al cargar datos para visualización:', error);
        });
}

function crearGraficoPrioridades(clientes) {
    const prioridades = [1, 2, 3, 4, 5];
    const datos = prioridades.map(p => clientes.filter(c => c.prioridad === p).length);
    const colores = ['#FF0000', '#FF6600', '#FFCC00', '#00CC00', '#0066CC'];
    
    const ctx = document.getElementById('chart-prioridades-carga').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Prioridad 1', 'Prioridad 2', 'Prioridad 3', 'Prioridad 4', 'Prioridad 5'],
            datasets: [{
                data: datos,
                backgroundColor: colores,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 10
                        }
                    }
                }
            }
        }
    });
}

function crearMapaPreview(clientes) {
    const container = document.getElementById('mapa-preview');
    
    if (mapaPreview) {
        mapaPreview.remove();
    }
    
    mapaPreview = L.map(container).setView([-12.0464, -77.0428], 11);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(mapaPreview);
    
    // Agregar marcador del depósito
    const depositIcon = L.divIcon({
        className: 'custom-div-icon',
        html: '<i class="fas fa-warehouse fa-lg text-primary"></i>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    L.marker([-12.0464, -77.0428], {icon: depositIcon})
        .addTo(mapaPreview)
        .bindPopup('<b>Depósito Central</b>');
    
    // Agregar marcadores de clientes
    clientes.forEach(cliente => {
        const color = getPriorityColor(cliente.prioridad);
        const icon = L.divIcon({
            className: 'custom-div-icon',
            html: `<i class="fas fa-store fa-sm" style="color: ${color}"></i>`,
            iconSize: [15, 15],
            iconAnchor: [7, 7]
        });
        
        L.marker([cliente.lat, cliente.lng], {icon: icon})
            .addTo(mapaPreview)
            .bindPopup(`<b>${cliente.nombre}</b><br>Prioridad: ${cliente.prioridad}`);
    });
}

function descargarEjemplo() {
    const ejemploCSV = `id,nombre,latitud,longitud,prioridad,ventana_inicio,ventana_fin,pedido
1,Supermercado Metro,-12.0464,-77.0428,1,08:00,12:00,150.5
2,Farmacia InkaFarma,-12.0564,-77.0328,2,09:00,17:00,200.0
3,Restaurante La Mar,-12.0364,-77.0528,3,10:00,16:00,75.25
4,Centro Comercial Jockey Plaza,-12.0664,-77.0228,1,08:30,11:30,300.0
5,Hotel Sheraton,-12.0264,-77.0628,4,14:00,18:00,125.75`;
    
    const blob = new Blob([ejemploCSV], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'clientes_ejemplo.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Éxito', 'Archivo de ejemplo descargado', 'success');
    }
}

function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('border-primary');
}

function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('border-primary');
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const fileInput = document.getElementById('archivo-csv');
        fileInput.files = files;
        
        // Simular cambio de evento
        const changeEvent = new Event('change', { bubbles: true });
        fileInput.dispatchEvent(changeEvent);
    }
}

function getPriorityColor(prioridad) {
    const colores = {
        1: '#FF0000',  // Rojo - Prioridad más alta
        2: '#FF6600',  // Naranja
        3: '#FFCC00',  // Amarillo
        4: '#00CC00',  // Verde
        5: '#0066CC'   // Azul - Prioridad más baja
    };
    return colores[prioridad] || '#999999';
}
</script>
{% endblock %} 