{% extends "layout.html" %}

{% block title %}Dashboard - Optimización de Rutas{% endblock %}

{% block content %}
<!-- Información de Datos Precargados -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h6 class="alert-heading">
                        <i class="fas fa-database me-2"></i>Dataset de Lima, Perú Precargado
                    </h6>
                    <p class="mb-0">
                        El sistema está cargado con <strong>1500 clientes</strong> distribuidos por el área metropolitana de Lima, Perú. 
                        Los datos incluyen supermercados, farmacias, centros comerciales, restaurantes, hoteles, universidades, 
                        hospitales, parques y plazas reales de Lima.
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border rounded p-2 bg-light">
                                <small class="text-muted">Total Clientes</small>
                                <div class="fw-bold text-primary">1500</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2 bg-light">
                                <small class="text-muted">Distritos</small>
                                <div class="fw-bold text-success">42</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Estadísticas -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ clientes_count }}</h4>
                        <p class="card-text">Clientes Registrados</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ vehiculos_count }}</h4>
                        <p class="card-text">Vehículos Disponibles</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-truck fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-warning text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="pedidos-total">0</h4>
                        <p class="card-text">Total Pedidos (kg)</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-box fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="capacidad-total">0</h4>
                        <p class="card-text">Capacidad Total (kg)</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-weight-hanging fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Mapa Principal -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-map me-2"></i>Mapa de Distribución - Lima, Perú
                </h5>
            </div>
            <div class="card-body p-0">
                <div id="mapa-principal" style="height: 500px;"></div>
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Haz clic en los marcadores para ver detalles
                        </small>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="toggleCapa('clientes')">
                                <i class="fas fa-users"></i> Clientes
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="toggleCapa('rutas')">
                                <i class="fas fa-route"></i> Rutas
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="toggleCapa('congestion')">
                                <i class="fas fa-traffic-light"></i> Congestión
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estadísticas Rápidas y Gráficos -->
    <div class="col-lg-4 mb-4">
        <!-- Estadísticas Rápidas -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Estadísticas Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <small class="text-muted">Prioridad Alta</small>
                            <div class="fw-bold text-danger" id="prioridad-alta">0</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <small class="text-muted">Ventanas Críticas</small>
                            <div class="fw-bold text-warning" id="ventanas-criticas">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gráfico de Distribución -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Distribución por Prioridad
                </h6>
            </div>
            <div class="card-body">
                <canvas id="chart-prioridades" width="300" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Botón Limpiar Datos -->
<div class="row">
    <div class="col-12">
        <div class="text-end">
            <button class="btn btn-outline-warning" onclick="limpiarDatos()">
                <i class="fas fa-trash me-2"></i>Limpiar Datos
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let mapa;
let marcadores = {};
let capas = {
    clientes: true,
    rutas: false,
    congestion: false
};

// Inicializar mapa
document.addEventListener('DOMContentLoaded', function() {
    inicializarMapa();
    cargarEstadisticas();
    actualizarEstadisticas();
});

function inicializarMapa() {
    // Crear mapa centrado en Lima
    mapa = L.map('mapa-principal').setView([-12.0464, -77.0428], 12);
    
    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(mapa);
    
    // Agregar marcador del depósito
    const depositoIcon = L.divIcon({
        className: 'custom-div-icon',
        html: '<i class="fas fa-warehouse fa-2x text-primary"></i>',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });
    
    L.marker([-12.0464, -77.0428], {icon: depositoIcon})
        .addTo(mapa)
        .bindPopup('<b>Depósito Central</b><br>Punto de partida de todas las rutas');
    
    // Cargar datos del mapa
    cargarDatosMapa();
}

function cargarDatosMapa() {
    fetch('/api/obtener_datos_mapa')
        .then(response => response.json())
        .then(data => {
            // Limpiar marcadores existentes
            Object.values(marcadores).forEach(marker => mapa.removeLayer(marker));
            marcadores = {};
            
            // Agregar marcadores de clientes
            data.clientes.forEach(cliente => {
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<i class="fas fa-store fa-lg" style="color: ${cliente.color}"></i>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                const marker = L.marker([cliente.lat, cliente.lng], {icon: icon})
                    .addTo(mapa)
                    .bindPopup(`
                        <b>${cliente.nombre}</b><br>
                        Prioridad: ${cliente.prioridad}<br>
                        Pedido: ${formatNumber(cliente.pedido)} kg<br>
                        Ventana: ${cliente.ventana_inicio} - ${cliente.ventana_fin}
                    `);
                
                marcadores[cliente.id] = marker;
            });
            
            // Agregar rutas si existen
            if (data.rutas && data.rutas.length > 0) {
                data.rutas.forEach(ruta => {
                    const polyline = L.polyline(ruta.coordenadas, {
                        color: ruta.color,
                        weight: 3,
                        opacity: 0.7
                    }).addTo(mapa);
                    
                    polyline.bindPopup(`
                        <b>Ruta ${ruta.id}</b><br>
                        Vehículo: ${ruta.placa}<br>
                        Distancia: ${formatDistance(ruta.distancia_total)}<br>
                        Tiempo: ${formatTime(ruta.tiempo_estimado)}<br>
                        Carga: ${formatNumber(ruta.carga_total)} kg
                    `);
                });
            }
        })
        .catch(error => {
            console.error('Error al cargar datos del mapa:', error);
            showToast('Error', 'No se pudieron cargar los datos del mapa', 'error');
        });
}

function cargarEstadisticas() {
    fetch('/api/estadisticas')
        .then(response => response.json())
        .then(data => {
            document.getElementById('pedidos-total').textContent = formatNumber(data.pedidos_total);
            document.getElementById('capacidad-total').textContent = formatNumber(data.capacidad_total);
            
            // Actualizar estadísticas de prioridad
            actualizarEstadisticasPrioridad();
        })
        .catch(error => {
            console.error('Error al cargar estadísticas:', error);
        });
}

function actualizarEstadisticas() {
    showLoading('Actualizando estadísticas...');
    
    Promise.all([
        fetch('/api/estadisticas'),
        fetch('/api/obtener_datos_mapa')
    ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(([stats, mapaData]) => {
        // Actualizar estadísticas
        document.getElementById('pedidos-total').textContent = formatNumber(stats.pedidos_total);
        document.getElementById('capacidad-total').textContent = formatNumber(stats.capacidad_total);
        
        // Actualizar mapa
        cargarDatosMapa();
        
        // Actualizar gráfico
        actualizarGraficoPrioridades(mapaData.clientes);
        
        hideLoading();
        showToast('Éxito', 'Estadísticas actualizadas correctamente', 'success');
    })
    .catch(error => {
        hideLoading();
        console.error('Error al actualizar estadísticas:', error);
        showToast('Error', 'No se pudieron actualizar las estadísticas', 'error');
    });
}

function actualizarEstadisticasPrioridad() {
    fetch('/api/obtener_datos_mapa')
        .then(response => response.json())
        .then(data => {
            const prioridadAlta = data.clientes.filter(c => c.prioridad <= 2).length;
            const ventanasCriticas = data.clientes.filter(c => {
                const inicio = c.ventana_inicio;
                const fin = c.ventana_fin;
                return inicio === '08:00' || fin === '18:00';
            }).length;
            
            document.getElementById('prioridad-alta').textContent = prioridadAlta;
            document.getElementById('ventanas-criticas').textContent = ventanasCriticas;
            
            // Actualizar gráfico
            actualizarGraficoPrioridades(data.clientes);
        })
        .catch(error => {
            console.error('Error al actualizar estadísticas de prioridad:', error);
        });
}

function actualizarGraficoPrioridades(clientes) {
    const ctx = document.getElementById('chart-prioridades').getContext('2d');
    
    // Contar clientes por prioridad
    const prioridades = [1, 2, 3, 4, 5];
    const datos = prioridades.map(p => clientes.filter(c => c.prioridad === p).length);
    
    const colores = ['#FF0000', '#FF6600', '#FFCC00', '#00CC00', '#0066CC'];
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Prioridad 1', 'Prioridad 2', 'Prioridad 3', 'Prioridad 4', 'Prioridad 5'],
            datasets: [{
                data: datos,
                backgroundColor: colores,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 10
                        }
                    }
                }
            }
        }
    });
}

function toggleCapa(tipo) {
    capas[tipo] = !capas[tipo];
    
    // Actualizar botones
    const boton = event.target.closest('button');
    if (capas[tipo]) {
        boton.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-outline-warning');
        boton.classList.add('btn-primary', 'btn-success', 'btn-warning');
    } else {
        boton.classList.remove('btn-primary', 'btn-success', 'btn-warning');
        boton.classList.add('btn-outline-primary', 'btn-outline-success', 'btn-outline-warning');
    }
    
    // Recargar mapa con capas actualizadas
    cargarDatosMapa();
}

function cargarDatosEjemplo() {
    showLoading('Cargando datos de ejemplo...');
    
    // Crear datos de ejemplo
    const datosEjemplo = `id,nombre,latitud,longitud,prioridad,ventana_inicio,ventana_fin,pedido
1,Cliente A,-12.0464,-77.0428,1,08:00,12:00,150.5
2,Cliente B,-12.0564,-77.0328,2,09:00,17:00,200.0
3,Cliente C,-12.0364,-77.0528,3,10:00,16:00,75.25
4,Cliente D,-12.0664,-77.0228,1,08:30,11:30,300.0
5,Cliente E,-12.0264,-77.0628,4,14:00,18:00,125.75`;
    
    const blob = new Blob([datosEjemplo], { type: 'text/csv' });
    const file = new File([blob], 'clientes_ejemplo.csv', { type: 'text/csv' });
    
    const formData = new FormData();
    formData.append('archivo', file);
    
    fetch('/api/cargar_csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast('Éxito', data.message, 'success');
            actualizarEstadisticas();
        } else {
            showToast('Error', data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('Error', 'Error al cargar datos de ejemplo', 'error');
    });
}

function registrarVehiculosEjemplo() {
    showLoading('Registrando vehículos de ejemplo...');
    
    const vehiculosEjemplo = [
        { placa: 'ABC-123', capacidad: 1000, tipo: 'Camión' },
        { placa: 'XYZ-789', capacidad: 500, tipo: 'Furgón' },
        { placa: 'DEF-456', capacidad: 200, tipo: 'Camioneta' }
    ];
    
    let registrados = 0;
    const total = vehiculosEjemplo.length;
    
    vehiculosEjemplo.forEach(vehiculo => {
        fetch('/api/registrar_vehiculo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(vehiculo)
        })
        .then(response => response.json())
        .then(data => {
            registrados++;
            if (registrados === total) {
                hideLoading();
                showToast('Éxito', `${registrados} vehículos registrados correctamente`, 'success');
                actualizarEstadisticas();
            }
        })
        .catch(error => {
            registrados++;
            if (registrados === total) {
                hideLoading();
                showToast('Error', 'Error al registrar algunos vehículos', 'error');
            }
        });
    });
}

function limpiarDatos() {
    if (confirm('¿Estás seguro de que quieres limpiar todos los datos? Esta acción no se puede deshacer.')) {
        showLoading('Limpiando datos...');
        
        // Recargar la página para limpiar datos
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }
}
</script>
{% endblock %} 